<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrganizationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">structure-microservice</a> &gt; <a href="index.source.html" class="el_package">pe.edu.vallegrande.ms_distribution.infrastructure.service</a> &gt; <span class="el_source">OrganizationService.java</span></div><h1>OrganizationService.java</h1><pre class="source lang-java linenums">package pe.edu.vallegrande.ms_distribution.infrastructure.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;
import pe.edu.vallegrande.ms_distribution.infrastructure.dto.external.AdminUserResponse;
import pe.edu.vallegrande.ms_distribution.infrastructure.dto.external.MsUsersApiResponse;
import pe.edu.vallegrande.ms_distribution.infrastructure.exception.CustomException;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import reactor.util.retry.Retry;

import java.time.Duration;
import java.util.List;
import java.util.Map;

/**
 * Servicio para consultar información de organizaciones y usuarios
 * desde el microservicio MS-USERS
 */
<span class="nc" id="L27">@Slf4j</span>
@Service
@RequiredArgsConstructor
public class OrganizationService {

    @Qualifier(&quot;msUsersWebClient&quot;)
    private final WebClient msUsersWebClient;
    
    private final ObjectMapper objectMapper;

    @Value(&quot;${external.apis.ms-users.endpoints.admins}&quot;)
    private String adminsEndpoint;

    @Value(&quot;${external.apis.ms-users.endpoints.users}&quot;)
    private String usersEndpoint;

    @Value(&quot;${external.apis.ms-users.endpoints.clients}&quot;)
    private String clientsEndpoint;

    @Value(&quot;${external.apis.ms-users.endpoints.user-by-id}&quot;)
    private String userByIdEndpoint;

    /**
     * Obtiene la lista de administradores autorizados por organización
     * 
     * @param organizationId ID de la organización
     * @return Flux de usuarios administradores
     */
    public Flux&lt;AdminUserResponse&gt; getAuthorizedAdminsByOrganization(String organizationId) {
<span class="nc" id="L56">        log.debug(&quot;Obteniendo administradores autorizados para organización: {}&quot;, organizationId);</span>
        
<span class="nc" id="L58">        var request = msUsersWebClient</span>
<span class="nc" id="L59">                .get()</span>
<span class="nc" id="L60">                .uri(adminsEndpoint, organizationId);</span>
                
<span class="nc" id="L62">        return request</span>
<span class="nc" id="L63">                .retrieve()</span>
<span class="nc" id="L64">                .onStatus(HttpStatus.NOT_FOUND::equals, response -&gt; {</span>
<span class="nc" id="L65">                    log.warn(&quot;Organización no encontrada: {}&quot;, organizationId);</span>
<span class="nc" id="L66">                    return Mono.error(new CustomException(404, &quot;ORGANIZATION_NOT_FOUND&quot;, </span>
                            &quot;No se encontró la organización: &quot; + organizationId));
                })
<span class="nc" id="L69">                .bodyToMono(MsUsersApiResponse.class)</span>
<span class="nc" id="L70">                .flatMapMany(response -&gt; {</span>
<span class="nc bnc" id="L71" title="All 4 branches missed.">                    if (response.getSuccess() &amp;&amp; response.getData() != null) {</span>
<span class="nc" id="L72">                        return Flux.fromIterable(response.getData())</span>
<span class="nc" id="L73">                                .cast(Map.class)</span>
<span class="nc" id="L74">                                .map(map -&gt; mapToAdminUserResponse((Map&lt;String, Object&gt;) map));</span>
                    } else {
<span class="nc" id="L76">                        log.warn(&quot;Respuesta de API sin éxito: {}&quot;, response.getMessage());</span>
<span class="nc" id="L77">                        return Flux.empty();</span>
                    }
                })
<span class="nc" id="L80">                .retryWhen(Retry.backoff(3, Duration.ofSeconds(1))</span>
<span class="nc" id="L81">                        .filter(throwable -&gt; throwable instanceof WebClientResponseException.InternalServerError))</span>
<span class="nc" id="L82">                .doOnNext(admin -&gt; log.debug(&quot;Admin encontrado: {}&quot;, admin.toString()))</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">                .doOnError(error -&gt; log.error(&quot;Error al obtener administradores: {}&quot;, error instanceof Throwable ? ((Throwable)error).getMessage() : error.toString()));</span>
    }

    /**
     * Verifica si un usuario es administrador autorizado de una organización
     * 
     * @param organizationId ID de la organización
     * @param userId ID del usuario a verificar
     * @return Mono&lt;Boolean&gt; indicando si es administrador autorizado
     */
    public Mono&lt;Boolean&gt; isAuthorizedAdmin(String organizationId, String userId) {
<span class="nc" id="L94">        log.debug(&quot;Verificando si usuario {} es admin autorizado de organización {}&quot;, userId, organizationId);</span>
        
<span class="nc" id="L96">        return getAuthorizedAdminsByOrganization(organizationId)</span>
<span class="nc" id="L97">                .any(admin -&gt; userId.equals(admin.getId()))</span>
<span class="nc" id="L98">                .doOnNext(isAuthorized -&gt; log.debug(&quot;Usuario {} {} autorizado para organización {}&quot;, </span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                        userId, isAuthorized ? &quot;es&quot; : &quot;no es&quot;, organizationId))</span>
<span class="nc" id="L100">                .onErrorReturn(false);</span>
    }

    /**
     * Obtiene un administrador específico por su ID y organización
     * 
     * @param organizationId ID de la organización
     * @param adminId ID del administrador
     * @return Mono del administrador encontrado
     */
    public Mono&lt;AdminUserResponse&gt; getAdminById(String organizationId, String adminId) {
<span class="nc" id="L111">        log.debug(&quot;Buscando administrador {} en organización {}&quot;, adminId, organizationId);</span>
        
<span class="nc" id="L113">        return getAuthorizedAdminsByOrganization(organizationId)</span>
<span class="nc" id="L114">                .filter(admin -&gt; adminId.equals(admin.getId()))</span>
<span class="nc" id="L115">                .next()</span>
<span class="nc" id="L116">                .switchIfEmpty(Mono.error(new CustomException(404, &quot;ADMIN_NOT_FOUND&quot;, </span>
                        &quot;Administrador no encontrado o no autorizado&quot;)));
    }

    /**
     * Verifica si una organización existe y tiene administradores
     * 
     * @param organizationId ID de la organización
     * @return Mono&lt;Boolean&gt; indicando si la organización existe
     */
    public Mono&lt;Boolean&gt; organizationExists(String organizationId) {
<span class="nc" id="L127">        log.debug(&quot;Verificando existencia de organización: {}&quot;, organizationId);</span>
        
<span class="nc" id="L129">        return getAuthorizedAdminsByOrganization(organizationId)</span>
<span class="nc" id="L130">                .hasElements()</span>
<span class="nc" id="L131">                .doOnNext(exists -&gt; log.debug(&quot;Organización {} {}&quot;, organizationId, </span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                        exists ? &quot;existe&quot; : &quot;no existe&quot;))</span>
<span class="nc" id="L133">                .onErrorReturn(false);</span>
    }

    /**
     * Obtiene usuarios de una organización desde /internal/organizations/{organizationId}/users
     */
    public Flux&lt;Object&gt; getOrganizationUsers(String organizationId) {
<span class="nc" id="L140">        log.debug(&quot;Obteniendo usuarios de organización: {}&quot;, organizationId);</span>
        
<span class="nc" id="L142">        var request = msUsersWebClient</span>
<span class="nc" id="L143">                .get()</span>
<span class="nc" id="L144">                .uri(usersEndpoint, organizationId);</span>
                
<span class="nc" id="L146">        return request</span>
<span class="nc" id="L147">                .retrieve()</span>
<span class="nc" id="L148">                .bodyToMono(MsUsersApiResponse.class)</span>
<span class="nc" id="L149">                .flatMapMany(response -&gt; {</span>
<span class="nc bnc" id="L150" title="All 4 branches missed.">                    if (response.getSuccess() &amp;&amp; response.getData() != null) {</span>
<span class="nc" id="L151">                        return Flux.fromIterable(response.getData());</span>
                    } else {
<span class="nc" id="L153">                        log.warn(&quot;Respuesta de API sin éxito: {}&quot;, response.getMessage());</span>
<span class="nc" id="L154">                        return Flux.empty();</span>
                    }
                })
<span class="nc bnc" id="L157" title="All 2 branches missed.">                .doOnError(error -&gt; log.error(&quot;Error al obtener usuarios: {}&quot;, error instanceof Throwable ? ((Throwable)error).getMessage() : error.toString()));</span>
    }

    /**
     * Obtiene clientes de una organización desde /internal/organizations/{organizationId}/clients
     */
    public Flux&lt;Object&gt; getOrganizationClients(String organizationId) {
<span class="nc" id="L164">        log.debug(&quot;Obteniendo clientes de organización: {}&quot;, organizationId);</span>
        
<span class="nc" id="L166">        var request = msUsersWebClient</span>
<span class="nc" id="L167">                .get()</span>
<span class="nc" id="L168">                .uri(clientsEndpoint, organizationId);</span>
                
<span class="nc" id="L170">        return request</span>
<span class="nc" id="L171">                .retrieve()</span>
<span class="nc" id="L172">                .bodyToMono(MsUsersApiResponse.class)</span>
<span class="nc" id="L173">                .flatMapMany(response -&gt; {</span>
<span class="nc bnc" id="L174" title="All 4 branches missed.">                    if (response.getSuccess() &amp;&amp; response.getData() != null) {</span>
<span class="nc" id="L175">                        return Flux.fromIterable(response.getData());</span>
                    } else {
<span class="nc" id="L177">                        log.warn(&quot;Respuesta de API sin éxito: {}&quot;, response.getMessage());</span>
<span class="nc" id="L178">                        return Flux.empty();</span>
                    }
                })
<span class="nc bnc" id="L181" title="All 2 branches missed.">                .doOnError(error -&gt; log.error(&quot;Error al obtener clientes: {}&quot;, error instanceof Throwable ? ((Throwable)error).getMessage() : error.toString()));</span>
    }

    /**
     * Obtiene un usuario por su ID desde /internal/users/{userId}
     */
    public Mono&lt;Object&gt; getUserById(String userId) {
<span class="nc" id="L188">        log.debug(&quot;Obteniendo usuario por ID: {}&quot;, userId);</span>
        
<span class="nc" id="L190">        var request = msUsersWebClient</span>
<span class="nc" id="L191">                .get()</span>
<span class="nc" id="L192">                .uri(userByIdEndpoint, userId);</span>
                
<span class="nc" id="L194">        return request</span>
<span class="nc" id="L195">                .retrieve()</span>
<span class="nc" id="L196">                .bodyToMono(Object.class)</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">                .doOnError(error -&gt; log.error(&quot;Error al obtener usuario por ID: {}&quot;, error instanceof Throwable ? ((Throwable)error).getMessage() : error.toString()));</span>
    }
    
    /**
     * Mapea un Map (LinkedHashMap) a AdminUserResponse
     */
    private AdminUserResponse mapToAdminUserResponse(Map&lt;String, Object&gt; map) {
        try {
<span class="nc" id="L205">            return objectMapper.convertValue(map, AdminUserResponse.class);</span>
<span class="nc" id="L206">        } catch (Exception e) {</span>
<span class="nc" id="L207">            log.error(&quot;Error al mapear AdminUserResponse: {}&quot;, e.getMessage());</span>
<span class="nc" id="L208">            throw new CustomException(500, &quot;MAPPING_ERROR&quot;, </span>
<span class="nc" id="L209">                    &quot;Error al mapear datos de administrador: &quot; + e.getMessage());</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>